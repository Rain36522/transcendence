{% extends "html/header.html" %}
{% load static %}

{% block content %}

<link rel="stylesheet" href="{% static 'generalchat.css' %}">
<div class="video-container">
    <img src="https://e1.pxfuel.com/desktop-wallpaper/281/253/desktop-wallpaper-best-6-80s-backgrounds-on-hip-retro-80s.jpg" alt="Background Image">
</div>    
<div class="chat-container">
    <div class="user-list">
        <div class="user" onclick="selectChat('User 1')">User 1</div>
        <div class="user" onclick="selectChat('User 2')">User 2</div>
        <div class="user" onclick="selectChat('User 3')">User 3</div>
        <hr>
        <div class="group" onclick="selectChat('Group 1')">Group 1</div>
        <div class="group" onclick="selectChat('Group 2')">Group 2</div>
    </div>
    <div class="chat-window">
        <div class="selected-user">Select a user or group to start chatting</div>
        <div id="messages">
            <!-- Messages will appear here -->
        </div>
        <div class="message-input">
            <textarea id="messageText" placeholder="Type your message here..."></textarea>
            <input type="hidden" id="imageData" />

            <div id="imagePreview"></div>
            <button id="sendMessage">Send</button>
        </div>
    </div>
</div>
<script>

    const socket = new WebSocket('wss://' + window.location.host + '/ws/your_url/1/');
    
    // Check if WebSocket connection is open
    socket.addEventListener('open', function(event) {
        console.log('WebSocket connection established.');
    });

    // Error handling for WebSocket connection
    socket.addEventListener('error', function(event) {
        console.error('WebSocket error:', event);
        // Handle error, e.g., display an error message to the user
    });

    socket.addEventListener('message', function (event) {
        // Handle incoming messages and render them in the chat-messages container
        const message = JSON.parse(event.data);
        console.log('Received message:', message);

        renderMessage(message);
    });

    function selectChat(chatName) {
        document.querySelector('.selected-user').textContent = "Chatting with: " + chatName;
        document.getElementById('messages').innerHTML = ''; // Clears previous messages
    }

    function renderMessage(message) {
        var messageBox = document.createElement('div');
        messageBox.style.display = "flex";
        messageBox.style.alignItems = "center";
        
        var usernameElement = document.createElement('span');
        usernameElement.textContent = message.username + ': ';
        usernameElement.style.fontWeight = "bold";
        usernameElement.style.marginRight = "5px";
        
        messageBox.appendChild(usernameElement);
        
        if (message.message) {
            // Check if the message contains text content
            var messageElement = document.createElement('div');
            messageElement.textContent = message.message;
            messageElement.style.padding = "10px";
            messageElement.style.margin = "5px 0";
            messageElement.style.backgroundColor = "#BDE0FE";
            messageElement.style.borderRadius = "10px";
            messageElement.style.wordWrap = "break-word";
            messageElement.style.overflowWrap = "break-word";
            messageElement.style.maxWidth = "80%";
            
            messageBox.appendChild(messageElement);
        }
    
        if (message.image) {
            // Check if the message contains image data
            var img = document.createElement('img');
            img.src = message.image;
            img.style.maxWidth = '200px'; // Adjust width as needed
            img.style.maxHeight = '200px'; // Adjust height as needed
            img.style.marginLeft = '10px'; // Adjust margin to separate image from text
            messageBox.appendChild(img);
        }
    
        document.getElementById('messages').appendChild(messageBox);
        scrollToBottom();
    }


    async function fetchMessages(chatId) {
        try {
            const response = await fetch(`/api/messages/${chatId}/`);
            if (!response.ok) {
                throw new Error('Failed to fetch messages');
            }
            const data = await response.json();
            return data;
        } catch (error) {
            console.error('Error fetching messages:', error);
            return [];
        }
    }

    fetchMessages(1).then(messages => {
        console.log(messages);
        for (var i = 0; i < messages.length; i++){
            var message = {
                "message": messages[i].content,
                "username": messages[i].sender,
                "image": messages[i].image
            }
            renderMessage(message);
            console.log(message);
        }
    })

    document.getElementById('sendMessage').addEventListener('click', function(event) {
        event.preventDefault();
        sendMessage();
    });

    // Handle Enter key press to send message
    document.getElementById('messageText').addEventListener('keypress', function(event) {
        scrollToBottom();

        if (event.key === 'Enter') {
            event.preventDefault();
            sendMessage();
        }
    });

    // Handle pasting image
    document.getElementById('messageText').addEventListener('paste', function(event) {
        var clipboardData = event.clipboardData || window.clipboardData;
        var items = clipboardData.items;

        for (var i = 0; i < items.length; i++) {
            if (items[i].type.indexOf('image') !== -1) {
                var blob = items[i].getAsFile();
                var reader = new FileReader();
                reader.onload = function(event) {
                    var imageData = event.target.result;
                    // Display the image preview
                    var imagePreview = document.getElementById('imagePreview');
                    var img = document.createElement('img');
                    img.src = imageData;
                    img.style.maxWidth = '200px'; // Adjust width as needed
                    img.style.maxHeight = '200px'; // Adjust height as needed
                    imagePreview.innerHTML = '';
                    imagePreview.appendChild(img);
                    document.getElementById('imageData').value = imageData;

                };
                reader.readAsDataURL(blob);
            }
        }
    });

    // Scroll to the bottom of the chat window
    function scrollToBottom() {
        var messagesContainer = document.getElementById('messages');
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function sendMessage() {
        var messageText = document.getElementById('messageText').value.trim();
        var imageData = document.getElementById('imageData').value;

        if (messageText !== '') {
            socket.send(JSON.stringify({ message: messageText }));
            document.getElementById('messageText').value = ''; // Clear the input after sending
            document.getElementById('imagePreview').innerHTML = ''; // Clear the image preview after sending
        }
        if (imageData != ''){
            // Optionally provide feedback to the user about empty message
            socket.send(JSON.stringify({ image: imageData }));
            document.getElementById('imageData').value = '';
            document.getElementById('imagePreview').innerHTML = '';
        }
    }

</script>

{% endblock %}